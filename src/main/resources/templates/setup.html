<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tor Relay Configuration</title>
    <link href="/css/tabs.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container">
    <h1 class="text-center my-4">Tor Relay Configuration</h1>

    <!-- Display success message if provided -->
    <div class="alert alert-success" th:if="${successMessage}" role="alert">
        <p th:text="${successMessage}"></p>
    </div>

    <!-- Create the tabs -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="relay-tab" data-toggle="tab" href="#relayTab" role="tab" aria-controls="relayTab" aria-selected="true">Guard Relay</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="bridge-tab" data-toggle="tab" href="#bridgeTab" role="tab" aria-controls="bridgeTab" aria-selected="false">Bridge</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="onion-tab" data-toggle="tab" href="#onionTab" role="tab" aria-controls="onionTab" aria-selected="false">Onion Service</a>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <!-- Relay Tab Content -->
        <div class="tab-pane fade show active" id="relayTab" role="tabpanel" aria-labelledby="relay-tab">
            <form>
                <div class="form-group">
                    <label for="relayNickname">Nickname:</label>
                    <input id="relayNickname" name="relayNickname" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="relayORPort">ORPort:</label>
                    <input id="relayORPort" name="relayORPort" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="relayContact">Contact:</label>
                    <input id="relayContact" name="relayContact" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="relayControlPort">Control Port:</label>
                    <input id="relayControlPort" name="relayControlPort" required type="text" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>

        <!-- Bridge Tab Content -->
        <div class="tab-pane fade" id="bridgeTab" role="tabpanel" aria-labelledby="bridge-tab">
            <form>
                <div class="form-group">
                    <label for="bridgeNickname">Nickname:</label>
                    <input id="bridgeNickname" name="bridgeNickname" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="bridgeORPort">ORPort:</label>
                    <input id="bridgeORPort" name="bridgeORPort" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="bridgeTransportListenAddr">ServerTransportListenAddr:</label>
                    <input id="bridgeTransportListenAddr" name="bridgeTransportListenAddr" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="bridgeContact">Contact:</label>
                    <input id="bridgeContact" name="bridgeContact" required type="text" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>

        <!-- Onion Tab Content -->
        <div class="tab-pane fade" id="onionTab" role="tabpanel" aria-labelledby="onion-tab">
            <form>
                <div class="form-group">
                    <label for="onionHiddenServiceDir">HiddenServiceDir:</label>
                    <input id="onionHiddenServiceDir" name="onionHiddenServiceDir" required type="text" class="form-control">
                </div>
                <div class="form-group">
                    <label for="onionHiddenServicePort">HiddenServicePort:</label>
                    <input id="onionHiddenServicePort" name="onionHiddenServicePort" required type="text" class="form-control">
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </div>

    <h2 class="text-center my-4">Running Relays</h2>
    <ul class="list-group">
        <li class="list-group-item" th:each="runningRelay : ${runningRelays}">
            <p th:text="${runningRelay}"></p>
        </li>
    </ul>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/js/tabs.js"></script> <!-- Include your JavaScript -->
<script>
    function toggleBridgeFields() {
        var bridgeType = document.getElementById("bridgeType").value;
        var commonFields = document.getElementById("commonFields");
        var bridgeFields = document.getElementById("bridgeFields");
        var webtunnelFields = document.getElementById("webtunnelFields");
        var snowflakeFields = document.getElementById("snowflakeFields");

        // Retrieve the form elements
        var bridgePort = document.getElementById("bridgePort");
        var bridgeTransportListenAddr = document.getElementById("bridgeTransportListenAddr");

        // Hide all fields initially
        commonFields.style.display = "none";
        bridgeFields.style.display = "none";
        webtunnelFields.style.display = "none";
        snowflakeFields.style.display = "none";

        // Remove 'required' attributes initially
        bridgePort.removeAttribute("required");
        bridgeTransportListenAddr.removeAttribute("required");

        // Show specific fields and add 'required' attributes based on the selected bridge type
        if (bridgeType === "bridge" || bridgeType === "webtunnel") {
            commonFields.style.display = "block";
        }

        if (bridgeType === "bridge") {
            bridgeFields.style.display = "block";
            bridgePort.setAttribute("required", "");
            bridgeTransportListenAddr.setAttribute("required", "");
        } else if (bridgeType === "webtunnel") {
            webtunnelFields.style.display = "block";
        } else if (bridgeType === "snowflake") {
            snowflakeFields.style.display = "block";
        }
    }

    // Call the function to initialize fields when the page loads
    window.onload = toggleBridgeFields;
</script>
<script>
    document.getElementById("runSnowflakeProxyButton").addEventListener("click", function () {
        $.ajax({
            url: '/bridge/run-snowflake-proxy',
            type: 'POST',
            success: function (response) {
                alert("Snowflake proxy started successfully");
            },
            error: function (error) {
                alert("Error starting snowflake proxy: " + error.responseText);
            }
        });
    });
</script>
<script>
    $.get("/bridge/limit-reached", function(data) {
        if (data.bridgeLimitReached) {
            document.getElementById('bridgeTabButton').disabled = true;
        }
    });
</script>
<script>
    $.get("/bridge/running-type", function(runningBridgeType) {
        if (runningBridgeType) {
            $("#bridgeType option").each(function() {
                if ($(this).val() !== runningBridgeType) {
                    $(this).prop("disabled", true);
                }
            });
        }
    });
</script>
</body>
</html>