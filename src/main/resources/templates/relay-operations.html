<!DOCTYPE html>
<html>
<head>
    <!-- Other head content... -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/navbar.css" rel="stylesheet">
</head>
<style>
    #edit-form input {
        display: block;
        margin-bottom: 10px;
    }
</style>
<body>
<div th:replace="navbar :: nav"></div>
<div class="container">
    <h1>Tor Relay Operations</h1>
    <button id="upnp-toggle-button" class="btn btn-primary" data-upnp-enabled="true">Disable UPnP for Guard Relays</button>

    <!-- Guard Relay Configurations -->
    <div class="row">
        <div class="col-md-12">
            <h2>Guard Relay Configurations</h2>
            <div id="guard-configs" class="list-group">
                <!-- Guard relay configurations will be added here dynamically -->
                <div th:each="config : ${guardConfigs}" class="list-group-item">
                    <h5 th:text="'Nickname: ' + ${config.getGuardConfig.nickname}"></h5>
                    <p th:text="'ORPort: ' + ${config.getGuardConfig.orPort}"></p>
                    <p th:text="'Contact: ' + ${config.getGuardConfig.contact}"></p>
                    <p th:text="'Control Port: ' + ${config.getGuardConfig.controlPort}"></p>
                    <p th:text="'Bandwidth Limit: ' + ${config.getGuardConfig.bandwidthRate}"></p>
                    <p>Status: <span th:id="${'status-' + config.getGuardConfig.nickname}">Unknown</span></p>
                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button class="btn btn-secondary edit-button"
                                th:attr="data-config-type='guard'"
                                th:data-config-contact="${config.getGuardConfig.contact}"
                                th:data-config-controlport="${config.getGuardConfig.controlPort}"
                                th:data-config-nickname="${config.getGuardConfig.nickname}"
                                th:data-config-orport="${config.getGuardConfig.orPort}"
                                th:data-config-bandwidthrate="${config.getGuardConfig.bandwidthRate}">
                            Edit
                        </button>
                        <button class="btn btn-secondary remove-button"
                                th:attr="data-config-type='guard'"
                                th:data-config-nickname="${config.getGuardConfig.nickname}">
                            Remove
                        </button>
                        <button class="btn btn-secondary start-button"
                                th:attr="data-config-type='guard'"
                                th:data-config-nickname="${config.getGuardConfig.nickname}">
                            Start
                        </button>
                        <button class="btn btn-secondary stop-button"
                                th:attr="data-config-type='guard'"
                                th:data-config-nickname="${config.getGuardConfig.nickname}">
                            Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Display Bridge relay configurations -->

    <h2>Bridge Relay Configurations</h2>
    <div class="row">
        <div class="col-md-12">
            <div id="bridge-configs" class="list-group">
                <div th:each="config : ${bridgeConfigs}" class="list-group-item">
                    <!-- Display Bridge relay configuration fields -->
                    <h5 th:text="'Nickname: ' + ${config.getBridgeConfig.nickname}"></h5>

                    <p th:text="'ORPort: ' + ${config.getBridgeConfig.orPort}"></p>
                    <p th:text="'ServerTransportListenAddr: ' + ${config.getBridgeConfig.getServerTransport}"></p>
                    <p th:text="'Contact: ' + ${config.getBridgeConfig.contact}"></p>
                    <p th:text="'Control Port: ' + ${config.getBridgeConfig.controlPort}"></p>
                    <p th:if="${webtunnelLinks[config.getBridgeConfig.nickname] != 'webtunnel 10.0.0.2:443 null url=null'}">Webtunnel Link: <span th:text="${webtunnelLinks[config.getBridgeConfig.nickname]}"></span></p>
                    <p>Status: <span th:id="${'status-' + config.getBridgeConfig.nickname}">Unknown</span></p>

                    <!-- Display type of bridge -->
                    <p>Type: <span th:id="${'bridge-type-' + config.getBridgeConfig.nickname}">Unknown</span></p>

                    <!-- The data-config-type can be set statically if it is known, or dynamically if needed -->
                    <div class="btn-group" role="group" aria-label="Basic example">
                        <button class="btn btn-secondary edit-bridge-button"
                                th:attr="data-config-type='bridge'"
                                th:data-config-contact="${config.getBridgeConfig.contact}"
                                th:data-config-controlport="${config.getBridgeConfig.controlPort}"
                                th:data-config-nickname="${config.getBridgeConfig.nickname}"
                                th:data-config-orport="${config.getBridgeConfig.orPort}"
                                th:data-config-servertransport="${config.getBridgeConfig.getServerTransport}"
                                th:data-config-webtunnelurl="${config.getBridgeConfig.webtunnelUrl}"
                                th:data-config-path="${config.getBridgeConfig.path}">
                            Edit
                        </button>
                        <button class="btn btn-secondary remove-button"
                                th:attr="data-config-type='bridge'"
                                th:data-config-nickname="${config.getBridgeConfig.nickname}">
                            Remove
                        </button>
                        <button class="btn btn-secondary start-button"
                                th:attr="data-config-type='bridge'"
                                th:data-config-nickname="${config.getBridgeConfig.nickname}">
                            Start
                        </button>
                        <button class="btn btn-secondary stop-button"
                                th:attr="data-config-type='bridge'"
                                th:data-config-nickname="${config.getBridgeConfig.nickname}">
                            Stop
                        </button>
                        <button class="btn btn-secondary">
                            <a th:href="@{/file/upload/80}">Edit Files</a>
                        </button>
                    </div>
                </div>
                <div th:if="${isSnowflakeConfigured}" id="snowflakeTab" class="tab-pane fade show active">
                    <h3>Snowflake Proxy</h3>
                    <p>Control the Snowflake Proxy from here.</p>
                    <button id="start-snowflake-proxy-button" class="btn btn-success">Start Snowflake Proxy</button>
                    <button id="stop-snowflake-proxy-button" class="btn btn-danger">Stop Snowflake Proxy</button>
                    <button id="remove-snowflake-proxy-button" class="btn btn-danger">Remove Snowflake Proxy</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            $.get("/relay-operations/upnp-availability", function(upnpAvailable) {
                if (upnpAvailable) {
                    $('#upnp-toggle-button').prop('disabled', false);
                } else {
                    $('#upnp-toggle-button').prop('disabled', true);
                }
            });
        });
    </script>

    <!-- Display Onion relay configurations -->
    <h2>Onion Relay Configurations</h2>
    <div class="row">
        <div class="col-md-12">
            <div id="onion-configs" class="list-group">
                <div th:each="config : ${onionConfigs}" class="list-group-item">
                    <!-- Display Onion relay configuration fields -->
                    <p th:text="'HiddenServicePort: ' + ${config.hiddenServicePort}"></p>
                    <p>Hostname: <span th:id="${'hostname-display-' + config.hiddenServicePort}"></span></p>
                    <p>Status: <span th:id="${'status-' + config.hiddenServicePort}">Unknown</span></p>
                    <div class="btn-group" role="group" aria-label="Basic example">

                        <button class="btn btn-secondary remove-button"
                                th:data-config-nickname="${config.hiddenServicePort}"
                                th:data-config-type="onion">
                            Remove
                        </button>
                        <button type="button" class="btn btn-secondary start-button" th:attr="data-config-type='onion'"
                                th:data-config-nickname="${config.hiddenServicePort}">
                            Start
                        </button>
                        <button class="btn btn-secondary stop-button"
                                th:attr="data-config-type='onion'"
                                th:data-config-dir="${config.hiddenServiceDir}"
                                th:data-config-nickname="${config.hiddenServicePort}"
                                th:data-config-port="${config.hiddenServicePort}">
                            Stop
                        </button>
                        <button class="btn btn-secondary">
                            <a th:href="@{/file/upload/{port}(port=${config.hiddenServicePort})}">Edit Files</a>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add modal for editing configurations (hidden by default) -->
<div class="modal" id="edit-modal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Configuration</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input id="edit-config-type" name="edit-config-type" type="hidden">

                    <label>Nickname:</label>
                    <p id="edit-nickname" data-config-type="guard bridge"></p>

                    <label for="edit-orport" data-config-type="guard bridge" data-bridge-type="obfs4">ORPort:</label>
                    <input id="edit-orport" name="edit-orport" type="number" min="1024" max="65535" data-config-type="guard" data-bridge-type="obfs4">

                    <label for="edit-server-transport" data-config-type="bridge" data-bridge-type="obfs4">ServerTransportListenAddr:</label>
                    <input id="edit-server-transport" name="edit-server-transport" type="number" min="1024" max="65535" data-config-type="bridge" data-bridge-type="obfs4">

                    <label for="edit-contact" data-config-type="guard bridge" data-bridge-type="obfs4 webtunnel">Contact:</label>
                    <input id="edit-contact" name="edit-contact" type="email" data-config-type="guard bridge" data-bridge-type="obfs4 webtunnel">

                    <label for="edit-controlport" data-config-type="guard bridge" data-bridge-type="obfs4">Control Port:</label>
                    <input id="edit-controlport" name="edit-controlport" type="number" min="1024" max="65535" data-config-type="guard" data-bridge-type="obfs4">

                    <!-- Additional fields for Onion relay configurations -->
                    <label for="edit-dir" data-config-type="onion">HiddenServiceDir:</label>
                    <input id="edit-dir" name="edit-dir" type="text" data-config-type="onion">

                    <label for="edit-hidden-service-port" data-config-type="onion">HiddenServicePort:</label>
                    <input id="edit-hidden-service-port" name="edit-hidden-service-port" type="number" min="1024" max="65535" data-config-type="onion">

                    <label for="edit-path" data-config-type="bridge" data-bridge-type="webtunnel" data-editable="false">Path:</label>
                    <input type="text" id="edit-path" data-config-type="bridge" data-bridge-type="webtunnel" data-editable="false">

                    <label for="edit-webtunnelurl" data-config-type="bridge" data-bridge-type="webtunnel" data-editable="false">Webtunnel URL:</label>
                    <input type="text" id="edit-webtunnelurl" data-config-type="bridge" data-bridge-type="webtunnel" data-editable="false">

                    <label for="edit-bandwidthrate" data-config-type="guard">Bandwidth Limit (KB/S):</label>
                    <input id="edit-bandwidthrate" name="edit-bandwidthrate" type="number" data-config-type="guard">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-button" type="button">Save</button>
                <button class="btn btn-secondary" data-dismiss="modal" id="cancel-button" type="button">Cancel</button>
            </div>
        </div>
    </div>
</div>

<table>
    <thead>
    <tr>
        <th>UPnP Managed Ports</th>
    </tr>
    </thead>
    <tbody>
    <!-- Loop through the list of ports managed by UPnP -->
    <tr th:each="port : ${upnpPorts}">
        <td th:text="${port}"></td>
    </tr>
    </tbody>
</table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/js/edit.js"></script>
<script src="/js/status.js"></script>
<script src="/js/start.js"></script>
<script src="/js/stop.js"></script>
<script src="/js/remove.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        function updateHostname() {
            fetch('/onion-service/current-hostnames')
                .then(response => response.json())
                .then(hostnames => {
                    // Iterate over each hostname
                    for (const [port, hostname] of Object.entries(hostnames)) {
                        // Find the corresponding HTML element and update its text content
                        const element = document.getElementById('hostname-display-' + port);
                        if (element) {
                            element.textContent = hostname;
                        }
                    }
                })
                .catch(error => console.error('Error fetching hostname:', error));
        }

        // Update hostname every 10 seconds
        setInterval(updateHostname, 10000);

        // Initial call to set hostname on page load
        updateHostname();
    });
</script>

<script>
    $(document).ready(function() {
        $.get("/bridge/running-type", function(runningBridgeTypes) {
            for (var bridgeNickname in runningBridgeTypes) {
                if (runningBridgeTypes.hasOwnProperty(bridgeNickname)) {
                    var bridgeType = runningBridgeTypes[bridgeNickname];
                    // Assuming each bridge has an element with id 'bridge-type-{nickname}'
                    var bridgeTypeElement = $("#bridge-type-" + bridgeNickname);
                    bridgeTypeElement.text(bridgeType);
                }
            }
        });
    });
</script>

<script>
    function toggleUPnP(enable) {
        $.ajax({
            url: '/relay-operations/toggle-upnp',
            type: 'POST',
            data: { enable: enable },
            success: function(response) {
                alert(response.message);
            },
            error: function(error) {
                console.error('Error:', error);
            }
        });
    }
</script>
<script>
    $(document).ready(function() {
        $('#upnp-toggle-button').click(function() {
            var button = $(this);
            var upnpEnabled = button.data('upnp-enabled');
            if (upnpEnabled) {
                toggleUPnP(false);
                button.text('Enable UPnP for Guard Relays');
            } else {
                toggleUPnP(true);
                button.text('Disable UPnP for Guard Relays');
            }
            button.data('upnp-enabled', !upnpEnabled);
        });
    });
</script>

<script>
    $(document).ready(function() {
        if ($('#guard-configs .list-group-item').length === 0) {
            $('h2:contains("Guard Relay Configurations")').hide();
        }
        if ($('#bridge-configs .list-group-item').length === 0) {
            $('h2:contains("Bridge Relay Configurations")').hide();
        }
        if ($('#onion-configs .list-group-item').length === 0) {
            $('h2:contains("Onion Relay Configurations")').hide();
        }
    });
</script>

<script>
    $(document).ready(function() {
        $('#start-snowflake-proxy-button').click(function() {
            $.ajax({
                type: "POST",
                url: "/relay-operations/start-snowflake-proxy",
                success: function(response) {
                    alert(response);
                }
            });
        });

        $('#stop-snowflake-proxy-button').click(function() {
            $.ajax({
                type: "POST",
                url: "/relay-operations/stop-snowflake-proxy",
                success: function(response) {
                    alert(response);
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('#remove-snowflake-proxy-button').click(function() {
            $.ajax({
                type: "POST",
                url: "/relay-operations/remove-snowflake-proxy",
                success: function(response) {
                    alert(response);
                }
            });
        });
    });
</script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>
